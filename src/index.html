<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <title>JRPG Stellar Engine Demo</title>
        <style type="text/css">

            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            body {
                overflow: hidden;
                background-color: #0ec4e1;
                user-select: none;
            }

            #canvas {
                display: block;
                image-rendering: optimizeSpeed;
                image-rendering: -moz-crisp-edges;
                image-rendering: -webkit-optimize-contrast;
                image-rendering: -o-crisp-edges;
                image-rendering: optimize-contrast;
                -ms-interpolation-mode: nearest-neighbor;
             }

             #touchpad {
                display: none;
                position: absolute;
                width: 80px;
                height: 80px;
                left: calc(50% - 40px);
                top: calc(50% - 40px);
                border-radius: 50%;
                background-color: rgba(255,255,255,0.5);
                border: 4px solid rgba(255,255,255,0.5);
             }

             #fps {
                position: absolute;
                bottom: 10px;
                left: 10px;
                color: white;
                font-size: 14px;
             }

        </style>
    </head>

    <body>

        <!-- Scripts -->
        <script src="sprite.js"></script>
        <script src="tileset.js"></script>
        <script src="actor.js"></script>
        <script src="mob.js"></script>
        <script src="player.js"></script>
        <script src="level.js"></script>
        <script src="loader-tsx.js"></script>
        <script src="loader-tmx.js"></script>
        <script src="utils.js"></script>
        <script src="view.js"></script>

        <!-- Resources -->
        <div style="display: none;">
            <img id="char1" src="../public/sprites/characters/chara_0.png">
            <img id="mob1" src="../public/sprites/characters/pinguin_22x22.png">
            <img id="blob1" src="../public/sprites/characters/blob_green.png">
            <img id="env1" src="../public/sprites/environment/ground.png">
            <img id="env2" src="../public/sprites/environment/water.png">
            <img id="sky" src="../public/sprites/environment/sky.png">
            <img id="chest1" src="../public/sprites/items/chest.png">
        </div>

        <!-- TSX -->
        <script id="test-tsx" type="text/xml">
            <tileset version="1.10" tiledversion="1.10.2" name="test" tilewidth="16" tileheight="16" tilecount="69" columns="20">
             <image source="../public/sprites/environment/ground.png" width="320" height="48"/>
            </tileset>
        </script>

        <script id="water-tsx" type="text/xml">
            <tileset version="1.10" tiledversion="1.10.2" name="water" tilewidth="16" tileheight="16" tilecount="9" columns="3">
             <image source="../public/sprites/environment/water.png" width="48" height="48"/>
            </tileset>
        </script>

        <!-- TMX -->
        <script id="test-tmx" type="text/xml">
            <map version="1.10" tiledversion="1.10.2" orientation="orthogonal" renderorder="right-down" width="30" height="30" tilewidth="16" tileheight="16" infinite="0" nextlayerid="10" nextobjectid="6">
             <tileset firstgid="1" source="test.tsx"/>
             <tileset firstgid="61" source="water.tsx"/>
             <imagelayer id="9" name="Background" locked="1" parallaxx="0.5" parallaxy="0" repeatx="1" repeaty="1">
              <image source="#sky" width="256" height="256"/>
             </imagelayer>
             <layer id="8" name="WaterSW" width="30" height="30" locked="1" offsetx="-240" offsety="240">
              <data encoding="csv">
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
            </data>
             </layer>
             <layer id="7" name="WaterSE" width="30" height="30" locked="1" offsetx="240" offsety="240">
              <data encoding="csv">
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
            </data>
             </layer>
             <layer id="6" name="WaterNE" width="30" height="30" locked="1" offsetx="240" offsety="-240">
              <data encoding="csv">
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,25,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,25,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            0,0,25,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0
            </data>
             </layer>
             <layer id="5" name="WaterNW" width="30" height="30" locked="1" offsetx="-240" offsety="-240">
              <data encoding="csv">
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,25,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,25,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,25,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,61,62,63,61,62,63,61,62,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,64,65,66,64,65,66,64,65,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,67,68,69,67,68,69,67,68,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
            </data>
             </layer>
             <layer id="1" name="Ground" width="30" height="30" locked="1">
              <data encoding="csv">
            25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,
            25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,
            37,25,7,8,8,8,9,25,37,25,25,25,25,25,25,25,25,25,25,25,25,25,25,7,8,8,8,9,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,25,25,25,25,25,25,25,25,25,37,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,37,25,25,25,25,36,25,25,25,25,38,25,25,25,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,36,25,25,25,25,38,25,25,25,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,36,25,25,25,25,38,25,25,25,25,37,27,28,28,28,29,25,37,
            25,25,27,28,28,28,29,25,25,25,25,25,25,25,25,25,60,25,25,25,25,25,37,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,1,2,2,2,2,2,2,2,2,2,2,3,25,25,27,28,28,28,29,25,25,
            25,25,47,48,48,48,49,25,25,21,22,22,22,22,22,22,22,22,22,22,23,25,25,47,48,48,48,49,25,25,
            25,25,25,25,25,25,25,25,25,21,22,22,22,22,22,22,22,22,22,22,23,25,25,25,25,25,25,25,25,25,
            25,25,25,25,25,25,25,25,25,21,22,22,4,5,5,5,5,6,22,22,23,25,25,25,25,25,25,25,37,25,
            25,25,25,25,25,25,25,25,37,21,22,22,24,25,25,25,25,26,22,22,23,25,25,25,37,25,25,25,25,25,
            25,25,25,25,25,25,25,25,25,21,22,22,24,25,25,25,25,26,22,22,23,25,25,25,25,25,25,25,25,25,
            25,25,25,25,25,37,25,25,25,21,22,22,24,25,25,25,25,26,22,22,23,25,25,25,25,25,25,25,25,25,
            25,25,25,37,25,25,25,25,25,21,22,22,24,25,25,25,25,26,22,22,23,25,25,25,37,25,25,25,25,25,
            25,25,25,25,25,25,25,25,25,21,22,22,44,45,45,45,45,46,22,22,23,25,25,25,25,25,25,25,25,25,
            25,25,25,25,25,25,25,25,25,21,22,22,22,22,22,22,22,22,22,22,23,25,25,25,25,25,25,25,25,25,
            25,25,7,8,8,8,9,25,25,21,22,22,22,22,22,22,22,22,22,22,23,37,25,7,8,8,8,9,25,25,
            25,25,27,28,28,28,29,25,25,41,42,42,42,42,42,42,42,42,42,42,43,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,25,25,25,25,25,25,25,25,37,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,37,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,27,28,28,28,29,25,25,
            25,25,27,28,28,28,29,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,27,28,28,28,29,25,25,
            25,25,47,48,48,48,49,25,37,25,25,25,25,25,25,25,25,25,37,37,25,25,37,47,48,48,48,49,25,25,
            25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,
            25,25,37,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25
            </data>
             </layer>
             <layer id="2" name="Colliders" class="Colliders" width="30" height="30" locked="1">
              <data encoding="csv">
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,19,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,57,20,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,16,17,17,17,17,18,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,25,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,50,51,52,0,0,0,0,0,0,56,57,57,57,0,58,0,0,0,0,0,0,50,51,52,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,39,17,17,17,17,18,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,17,17,17,17,40,0,
            0,0,0,0,0,0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,0,0,0,0,0,
            0,0,0,0,0,0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,0,0,0,0,0,
            0,0,0,0,0,0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,0,0,0,0,0,
            0,0,53,54,55,0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,53,54,55,0,0,
            0,0,0,0,0,0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,0,0,0,0,0,
            0,0,0,0,0,0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,0,0,0,0,0,
            0,19,57,57,57,57,58,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,56,57,57,57,57,20,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,50,51,52,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,50,51,52,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,36,0,
            0,39,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,17,40,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
            </data>
             </layer>
             <objectgroup id="4" name="Objects" locked="1">
              <object id="1" name="Level" type="Center" x="240" y="240">
               <point/>
              </object>
              <object id="2" name="Player" type="Spawn" x="168" y="240">
               <point/>
              </object>
              <object id="3" name="MOB" type="Spawn" x="312" y="240">
               <point/>
              </object>
              <object id="4" name="Slope-E" type="Stairs" x="272.25" y="48.375">
               <polygon points="0,0 15.625,15.5 15.75,79.25 -0.25,63.75"/>
              </object>
              <object id="5" name="Slope-W" type="Stairs" x="207.875" y="47.875">
               <polygon points="0,0 -15.75,16 -15.75,79.75 0.125,64.125"/>
              </object>
             </objectgroup>
             <layer id="3" name="Cover" width="30" height="30" locked="1">
              <data encoding="csv">
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,10,11,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,11,12,0,0,0,
            0,0,0,30,31,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,30,31,32,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,13,14,15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,13,14,15,0,0,
            0,0,33,34,35,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,33,34,35,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,10,11,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,11,12,0,0,0,
            0,0,0,30,31,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,30,31,32,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
            </data>
             </layer>
            </map>
        </script>

        <!-- Main canvas window -->
        <canvas id="main"></canvas>

        <!-- Mobile joystick -->
        <div id="touchpad"></div>

        <!-- Frames per second counter -->
        <div id="fps">FPS:</div>

        <!-- Init -->
        <script type="text/javascript">

            // Rendering
            let level = null;
            let view = null;
            const scale = 4;

            // Input actions
            const input = {
                up: false,
                down: false,
                left: false,
                right: false,
                action: false
            };

            // Mobile input
            const mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const touchCenter = {x: 0, y: 0};
            const touchPad = document.getElementById('touchpad');

            const keyDownHandler = (event) => {
                if (event.code == 'ArrowRight' || event.code == 'KeyD') {
                    input.right = true;
                }
                else if (event.code == 'ArrowLeft' || event.code == 'KeyA') {
                    input.left = true;
                }
                if (event.code == 'ArrowUp' || event.code == 'KeyW') {
                    input.up = true;
                }
                else if (event.code == 'ArrowDown' || event.code == 'KeyS') {
                    input.down = true;
                }
                if (event.code == 'Space' || event.code == 'ControlRight' || event.code == 'ControlLeft' || event.key == 'Enter') {
                    input.action = true;
                }
            };

            const keyUpHandler = (event) => {
                if (event.code == 'ArrowRight' || event.code == 'KeyD') {
                    input.right = false;
                }
                if (event.code == 'ArrowLeft' || event.code == 'KeyA') {
                    input.left = false;
                }
                if (event.code == 'ArrowUp' || event.code == 'KeyW') {
                    input.up = false;
                }
                if (event.code == 'ArrowDown' || event.code == 'KeyS') {
                    input.down = false;
                }
                if (event.code == 'Space' || event.code == 'ControlRight' || event.code == 'ControlLeft' || event.key == 'Enter') {
                    input.action = false;
                }
                level.chars.player.idle();
            };

            const touchStartHandler = (event) => {
                const firstTouch = event.touches[0];
                touchPad.style.display = 'block';
                touchCenter.x = firstTouch.pageX;
                touchCenter.y = firstTouch.pageY;
                touchPad.style.left = `${touchCenter.x - 44}px`;
                touchPad.style.top = `${touchCenter.y - 44}px`;
            };

            const touchMoveHandler = (event) => {
                event.preventDefault();
                const firstTouch = event.touches[0];
                const posX = firstTouch.pageX;
                const posY = firstTouch.pageY;
                touchPad.style.left = `${posX - 44}px`;
                touchPad.style.top = `${posY - 44}px`;

                input.right = false;
                input.left = false;
                input.up = false;
                input.down = false;

                const threshold = 10;
                if (posX + threshold < touchCenter.x) {
                    input.left = true;
                    // touchCenter.y = posY;
                }
                else if (posX - threshold > touchCenter.x) {
                    input.right = true;
                    // touchCenter.y = posY;
                }
                if (posY + threshold < touchCenter.y) {
                    input.up = true;
                    // touchCenter.x = posX;
                }
                else if (posY - threshold > touchCenter.y) {
                    input.down = true;
                    // touchCenter.x = posX;
                }
            };

            const touchEndHandler = (event) => {
                touchPad.style.display = 'none';
                input.right = false;
                input.left = false;
                input.up = false;
                input.down = false;
            };

            // Keyboard input
            if (!mobile) {
                document.addEventListener('keydown', keyDownHandler);
                document.addEventListener('keyup', keyUpHandler);
            }

            // Mobile touch
            else {
                document.addEventListener('touchstart', touchStartHandler);
                document.addEventListener('touchmove', touchMoveHandler);
                document.addEventListener('touchend', touchEndHandler);
            }

            // Disable native context menu
            window.addEventListener('contextmenu', function(event) {
                event.preventDefault();
            });

            // Init
            window.addEventListener('load', () => {

                // Initialize view context
                view = new View({ canvas: document.getElementById('main'), debug: true });

                // Load level
                const loaderTSX = new LoaderTSX();
                const loaderTMX = new LoaderTMX({
                    'test.tsx': loaderTSX.parseTileSet({ xml: document.getElementById('test-tsx').innerText, resource: '#env1', scale }),
                    'water.tsx': loaderTSX.parseTileSet({ xml: document.getElementById('water-tsx').innerText, resource: '#env2', scale })
                });
                level = loaderTMX.parseLevel({ xml: document.getElementById('test-tmx').innerText, scale });

                // Initialize player
                level.chars['player'] = new Player({
                    resource: '#char1',
                    width: 48,
                    height: 80,
                    cols: 3,
                    rows: 4,
                    scale: scale,
                    speed: 320,
                    anim: {
                        speed: 10,
                        idleUp: [10],
                        idleDown: [1],
                        idleLeft: [4],
                        idleRight: [7],
                        moveUp: [9, 10, 11],
                        moveDown: [0, 1, 2],
                        moveLeft: [3, 4, 5],
                        moveRight: [6, 7, 8],
                    },
                    collider: {
                        x: 7,
                        y: 50,
                        width: 50,
                        height: 30
                    },
                    bounds: {
                        top: -150,
                        bottom: 150,
                        left: -150,
                        right: 150
                    },
                    transform: level.getSpawnPoint('player', {x: 0, y: 0})
                });
                level.chars.player.idle();

                // Centre view context on player
                view.centre(level.chars.player.transform);

                // MOB wandering
                level.chars['penguin1'] = new MOB({
                    resource: '#mob1',
                    width: 88,
                    height: 88,
                    cols: 4,
                    rows: 4,
                    scale: scale,
                    speed: 80,
                    anim: {
                        speed: 10,
                        idle: [1],
                        moveUp: [8, 9, 10],
                        moveDown: [0, 1, 2],
                        moveLeft: [12, 13, 14],
                        moveRight: [4, 5, 6],
                    },
                    collider: {
                        x: 0,
                        y: 0,
                        width: 22 * scale,
                        height: 22 * scale
                    },
                    transform: level.getSpawnPoint('mob', {x: 280, y: 0})
                });
                level.chars.penguin1.wander();

                // MOB fleeing
                level.chars['blob1'] = new MOB({
                    resource: '#blob1',
                    width: 57,
                    height: 57,
                    cols: 3,
                    rows: 3,
                    scale: scale,
                    speed: 80,
                    anim: {
                        speed: 10,
                        idle: [0, 1, 2],
                        moveUp: [0, 1, 2],
                        moveDown: [0, 1, 2],
                        moveLeft: [3, 4, 5],
                        moveRight: [6, 7, 8],
                    },
                    collider: {
                        x: 0,
                        y: 0,
                        width: 19 * scale,
                        height: 19 * scale
                    },
                    transform: {x: 0, y: 0}
                });
                level.chars.blob1.wander();

                // Chest
                level.items['chest'] = new Actor({
                    resource: '#chest1',
                    width: 32,
                    height: 16,
                    cols: 2,
                    rows: 1,
                    scale: scale,
                    collider: {
                        x: -4 * scale,
                        y: -4 * scale,
                        width: 24 * scale,
                        height: 24 * scale
                    },
                    transform: {
                        x: -30,
                        y: -608
                    }
                });

                // Start
                requestAnimationFrame(function(currentTime) {
                    lastTime = currentTime;
                    mainLoop(currentTime);
                });

            });

            // Player movement
            const playerMoveUp = (deltaTime) => {

                // Collide
                const [x, y] = level.chars.player.collideUp({
                    view,
                    deltaTime,
                    with: level.getColliders(view)
                });

                // Slide
                if (x < -0.1) level.chars.player.moveLeft(-x, view);
                else if (x > 0.1) level.chars.player.moveRight(x, view);

                // Anim & Move
                level.chars.player.animUp(deltaTime);
                level.chars.player.moveUp(y, view);
            };

            const playerMoveDown = (deltaTime) => {

                // Collide
                const [x, y] = level.chars.player.collideDown({
                    view,
                    deltaTime,
                    with: level.getColliders(view)
                });

                // Slide
                if (x < -0.1) level.chars.player.moveLeft(-x, view);
                else if (x > 0.1) level.chars.player.moveRight(x, view);

                // Anim & Move
                level.chars.player.animDown(deltaTime);
                level.chars.player.moveDown(y, view);
            };

            const playerMoveLeft = (deltaTime) => {

                // Collide
                let [x, y] = level.chars.player.collideLeft({
                    view,
                    deltaTime,
                    with: level.getColliders(view)
                });

                // Stairs
                const [stx, sty] = level.chars.player.stairsLeft({
                    view,
                    deltaTime,
                    with: level.getStairs(view)
                });

                // Update
                x += stx;
                y += sty;

                // Slide
                if (y < -0.1) level.chars.player.moveUp(-y, view);
                else if (y > 0.1) level.chars.player.moveDown(y, view);

                // Anim & Move
                level.chars.player.animLeft(deltaTime);
                level.chars.player.moveLeft(x, view);
            };

            const playerMoveRight = (deltaTime) => {

                // Collide
                let [x, y] = level.chars.player.collideRight({
                    view,
                    deltaTime,
                    with: level.getColliders(view)
                });

                // Stairs
                const [stx, sty] = level.chars.player.stairsRight({
                    view,
                    deltaTime,
                    with: level.getStairs(view)
                });

                // Update
                x += stx;
                y += sty;

                // Slide
                if (y < -0.1) level.chars.player.moveUp(-y, view);
                else if (y > 0.1) level.chars.player.moveDown(y, view);

                // Anim & Move
                level.chars.player.animRight(deltaTime);
                level.chars.player.moveRight(x, view);
            };

            // Main loop
            let lastTime = 0;
            let fpsContainer = document.querySelector('#fps');
            const mainLoop = (currentTime) => {

                // Universal frame time
                const deltaTime = (currentTime - lastTime) / 1000;

                // Calculate FPS
                fpsContainer.textContent = `FPS: ${Math.round(1 / deltaTime)}`;

                // Player movement
                if (input.up) {
                    playerMoveUp(deltaTime);
                }
                else if (input.down) {
                    playerMoveDown(deltaTime);
                }
                if (input.left) {
                    playerMoveLeft(deltaTime);
                }
                else if (input.right) {
                    playerMoveRight(deltaTime);
                }

                // Player actions
                if (input.action) {
                    if (level.chars.player.collideWith({with: level.items.chest, view}) && level.items.chest.frame === 0) {
                        level.items.chest.frame = 1;
                    }
                }

                // Mobs movement
                level.chars.penguin1.update({
                    view,
                    deltaTime,
                    colliders: level.getColliders(view)
                });
                level.chars.blob1.update({
                    view,
                    deltaTime,
                    colliders: level.getColliders(view)
                });

                // Render environment
                level.render(view);
                level.debug(view);

                // Time udpate
                lastTime = currentTime;

                // Display synchro
                requestAnimationFrame(mainLoop);
            }

        </script>

    </body>

</html>
