<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <title>Stellar Engine Demo</title>
        <style type="text/css">

            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            #canvas {
                display: block;
            }

        </style>
    </head>

    <body>

        <!-- Scripts -->
        <script src="tileset.js"></script>
        <script src="sprite.js"></script>
        <script src="loader-tsx.js"></script>
        <script src="loader-tmx.js"></script>

        <!-- Resources -->
        <div style="display: none;">
            <img id="char1" src="../public/sprites/characters/chara_0.png">
            <img id="env1" src="../public/sprites/environment/ground.png">
        </div>

        <!-- TSX -->
        <script id="test-tsx" type="text/xml">
            <tileset version="1.10" tiledversion="1.10.2" name="test" tilewidth="16" tileheight="16" tilecount="60" columns="20">
             <image source="../sprites/environment/ground.png" width="320" height="48"/>
            </tileset>
        </script>

        <!-- TMX -->
        <script id="test-tmx" type="text/xml">
            <map version="1.10" tiledversion="1.10.2" orientation="orthogonal" renderorder="right-down" width="30" height="30" tilewidth="16" tileheight="16" infinite="0" nextlayerid="2" nextobjectid="1">
             <tileset firstgid="1" source="test.tsx"/>
             <layer id="1" name="GroundLayer" width="30" height="30">
              <data encoding="csv">
            31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,
            31,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,31,
            31,37,7,8,8,8,9,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,1,2,2,2,3,37,31,
            31,37,27,28,28,28,29,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,21,22,22,22,23,37,31,
            31,37,27,28,28,28,29,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,21,22,22,22,23,37,31,
            31,37,27,28,28,28,29,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,21,22,22,22,23,37,31,
            31,37,47,48,48,48,49,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,41,42,42,42,43,37,31,
            31,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,10,11,11,11,11,11,11,11,11,11,11,12,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,30,31,31,31,31,31,31,31,31,31,31,32,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,50,51,51,51,51,51,51,51,51,51,51,52,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,31,
            31,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,31,
            31,37,4,5,5,5,6,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,13,14,14,14,15,37,31,
            31,37,24,25,25,25,26,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,33,34,34,34,35,37,31,
            31,37,24,25,25,25,26,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,33,34,34,34,35,37,31,
            31,37,24,25,25,25,26,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,33,34,34,34,35,37,31,
            31,37,44,45,45,45,46,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,53,54,54,54,55,37,31,
            31,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,31,
            31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31
            </data>
             </layer>
            </map>
        </script>

        <!-- Main canvas window -->
        <canvas id="main"></canvas>

        <!-- Init -->
        <script type="text/javascript">

            // Globals
            const canvas = document.getElementById('main');
            let player = null;
            let tileset = null;
            let level = null;

            // Round number
            function roundToNearestEven(number) {
                let roundedNumber = Math.round(number);
                if (roundedNumber % 2 !== 0) roundedNumber += 1;
                return roundedNumber;
            }

            // Window
            function fitCanvas() {
                canvas.width = roundToNearestEven(window.innerWidth);
                canvas.height = roundToNearestEven(window.innerHeight);
            }

            // Input actions
            const input = {
                up: false,
                down: false,
                left: false,
                right: false
            };

            const keyDownHandler = (event) => {
                switch (event.key) {
                    case 'ArrowRight':
                        input.right = true;
                        break;
                    case 'ArrowLeft':
                        input.left = true;
                        break;
                    case 'ArrowUp':
                        input.up = true;
                        break;
                    case 'ArrowDown':
                        input.down = true;
                        break;
                }
            };

            const keyUpHandler = (event) => {
                switch (event.key) {
                    case 'ArrowRight':
                        input.right = false;
                        break;
                    case 'ArrowLeft':
                        input.left = false;
                        break;
                    case 'ArrowUp':
                        input.up = false;
                        break;
                    case 'ArrowDown':
                        input.down = false;
                        break;
                }
            };

            // Keyboard input
            document.addEventListener('keydown', keyDownHandler);
            document.addEventListener('keyup', keyUpHandler);

            // Main loop
            let lastTime = 0;
            const mainLoop = (currentTime) => {

                // Universal frame time
                const deltaTime = (currentTime - lastTime) / 1000;

                // Background
                tileset.renderArea(-10, -8, level);

                // Player movement
                if (input.up) player.moveUp(deltaTime);
                else if (input.down) player.moveDown(deltaTime);
                if (input.left) player.moveLeft(deltaTime);
                else if (input.right) player.moveRight(deltaTime);
                player.render();

                // Time udpate
                lastTime = currentTime;

                // Display synchro
                requestAnimationFrame(mainLoop);
            }

            // Init
            window.addEventListener('load', () => {

                // Canvas init
                fitCanvas();
                const context = canvas.getContext('2d');
                context.imageSmoothingEnabled = false;

                // Tileset for ground
                const loaderTSX = new LoaderTSX({canvas, context});
                tileset = loaderTSX.parseTileSet(document.getElementById('test-tsx').innerText, '#env1');

                // Map
                const loaderTMX = new LoaderTMX();
                level = loaderTMX.parseLevel(document.getElementById('test-tmx').innerText).layer0;

                // Player
                player = new Sprite({
                    canvas,
                    context,
                    resource: '#char1',
                    width: 48,
                    height: 80,
                    cols: 3,
                    rows: 4,
                    scale: 4,
                    speed: 320,
                    anim: {
                        speed: 0.1,
                        idle: [1],
                        moveUp: [9, 10, 11],
                        moveDown: [0, 1, 2],
                        moveLeft: [3, 4, 5],
                        moveRight: [6, 7, 8],
                    }
                });

                // Start
                requestAnimationFrame(function(currentTime) {
                    lastTime = currentTime;
                    mainLoop(currentTime);
                });

            });

            // Resize
            window.addEventListener('resize', () => {
                fitCanvas();
            });

        </script>

    </body>

</html>
